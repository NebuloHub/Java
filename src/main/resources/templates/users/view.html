<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{layout/main :: layout(pageTitle=#{user.profile.pageTitle(${profileUser.username})}, content=~{::main})}">

<main>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10 mt-5">

                <div th:if="${profileSuccess}" class="alert alert-success" th:text="${profileSuccess}"></div>

                <div class="row">

                    <div class="col-md-5">

                        <div class="profile-header-card mb-4">
                            <h1 th:text="${profileUser.username}">Username</h1>
                            <p class="text-muted" th:text="${profileUser.email}">user.email@example.com</p>
                            <small class="text-muted" th:text="|#{user.profile.memberSince} ${#temporals.format(profileUser.createdAt, 'dd MMM yyyy')}|">
                                Member since 10 Jan 2025
                            </small>

                            <div class="profile-actions">

                                <a th:href="@{|/users/${profileUser.id}/edit|}"
                                   class="btn btn-secondary w-100"
                                   th:text="#{user.profile.edit}"
                                   th:if="${#authentication != null AND #authentication.isAuthenticated() AND #authentication.name == profileUser.email}">
                                    Edit Profile
                                </a>

                                <form th:action="@{|/users/${profileUser.id}/delete|}" method="post" class="w-100"
                                      th:if="${#authentication != null AND #authentication.isAuthenticated() AND
                                             (#authentication.name == profileUser.email OR #authorization.expression('hasRole(''ADMIN'')'))}"
                                      onsubmit="return confirm('Are you sure you want to delete this profile? This action cannot be undone.');">

                                    <button type="submit" class="btn btn-danger w-100" th:text="#{user.profile.delete}">
                                        Delete Profile
                                    </button>
                                </form>
                            </div>

                        </div>

                        <h2 class="profile-section-title" th:text="#{user.profile.commentsTitle(${profileUser.username})}">
                            Comments by Username
                        </h2>

                        <div th:if="${commentPage.empty}" class="profile-comments-card text-center text-muted mb-4">
                            <p class="mb-0" th:text="#{user.profile.noComments}">This user hasn't commented yet.</p>
                        </div>

                        <div th:if="${!commentPage.empty}" class="profile-comments-card mb-4">
                            <div class="post-comments">
                                <div th:each="comment : ${commentPage.content}" class="comment-item d-flex justify-content-between align-items-start">

                                    <div class="me-3">
                                        <span class="formatted-text profile-comment-content" th:text="${comment.content}">
                                            Comment content.
                                        </span>
                                        <a th:href="@{|/posts/${comment.postId}|}" class="comment-on-post-title fst-italic">
                                            (<span th:text="#{user.profile.onPost}">on post</span>: "<span th:text="${comment.postTitle}">Post Title</span>")
                                        </a>
                                    </div>

                                    <div th:if="${#authorization.expression('isAuthenticated()') AND #authentication.principal.id == comment.userId}"
                                         class="comment-delete-form flex-shrink-0">

                                        <form th:action="@{|/comments/${comment.postId}/delete/${comment.id}?redirect=user&userId=${profileUser.id}|}"
                                              method="post"
                                              th:data-confirm-message="#{comment.manage.delete.confirm}"
                                              onsubmit="return confirm(this.getAttribute('data-confirm-message'));">

                                            <button type="submit" class="btn-delete-comment">
                                                &times; </button>
                                        </form>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div> <div class="col-md-7">

                    <h2 class="profile-section-title" th:text="#{user.profile.postsTitle(${profileUser.username})}">
                        Posts by Username
                    </h2>

                    <div th:if="${postPage.empty}" class="card post-card mb-4">
                        <div class="card-body text-center text-muted p-4">
                            <p class="mb-0" th:text="#{user.profile.noPosts}">This user hasn't posted any ideas yet.</p>
                        </div>
                    </div>

                    <div th:if="${!postPage.empty}" class="post-feed">
                        <div th:each="post : ${postPage.content}" class="card post-card mb-4">
                            <div class="card-body">
                                <h4 class="card-title">
                                    <a th:href="@{|/posts/${post.id}|}" th:text="${post.title}">Post Title</a>
                                </h4>
                                <p class="card-text formatted-text"
                                   th:text="${#strings.length(post.description) > 300} ?
                                                  (${#strings.substring(post.description, 0, 300)} + '...') :
                                                  ${post.description}">
                                    Post description...
                                </p>
                            </div>
                            <div class="card-footer post-stats">
                                    <span class="text-muted">
                                        <strong class="rating-highlight" th:text="#{user.profile.rating}">Rating</strong>:
                                        <span th:text="${#numbers.formatDecimal(post.avgRating, 1, 1)}">8.5</span> / 10
                                        (<span th:text="${post.ratingCount}">10</span> <span th:text="#{user.profile.votes}">votes</span>)
                                    </span>
                                <small class="text-muted" th:text="${#temporals.format(post.createdAt, 'dd MMM yyyy')}">
                                    10 Jan 2025
                                </small>
                            </div>
                        </div>
                    </div>

                    <nav th:if="${postPage.totalPages > 1}" aria-label="Post page navigation" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${postPage.first} ? 'disabled'">
                                <a class="page-link" th:href="@{|/users/${profileUser.id}?page=${postPage.number - 1}|}">&laquo;</a>
                            </li>
                            <li th:each="i : ${#numbers.sequence(0, postPage.totalPages - 1)}"
                                class="page-item" th:classappend="${i == postPage.number} ? 'active'">
                                <a class="page-link" th:href="@{|/users/${profileUser.id}?page=${i}|}" th:text="${i + 1}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${postPage.last} ? 'disabled'">
                                <a class="page-link" th:href="@{|/users/${profileUser.id}?page=${postPage.number + 1}|}">&raquo;</a>
                            </li>
                        </ul>
                    </nav>

                </div> </div> </div> </div> </div> </main>
</html>